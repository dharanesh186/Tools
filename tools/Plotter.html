<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Advanced Data Observer | Fixed Edition</title>
  <script src="https://cdn.jsdelivr.net/npm/xlsx/dist/xlsx.full.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    :root {
      --space-dark: #0b0d17;
      --nebula-purple: #6e45e2;
      --star-white: #f8f9fa;
      --success-green: #28a745;
    }
    
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background: radial-gradient(circle at center, #1b2735 0%, #090a0f 100%);
      color: var(--star-white);
      margin: 0; 
      padding: 20px;
      min-height: 100vh;
    }

    .container {
      max-width: 1100px;
      margin: auto;
    }

    h2 {
      text-align: center;
      letter-spacing: 2px;
      text-transform: uppercase;
      text-shadow: 0 0 10px rgba(110, 69, 226, 0.5);
    }

    .card {
      background: rgba(255, 255, 255, 0.07);
      padding: 25px;
      border-radius: 16px;
      border: 1px solid rgba(255, 255, 255, 0.1);
      backdrop-filter: blur(12px);
      margin-bottom: 20px;
      box-shadow: 0 8px 32px 0 rgba(0, 0, 0, 0.37);
    }

    .grid { 
      display: grid; 
      grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); 
      gap: 20px; 
    }

    label {
      display: block;
      margin-bottom: 8px;
      font-size: 0.9rem;
      color: #aaa;
    }

    input, select, button {
      width: 100%; 
      padding: 12px; 
      margin-top: 5px;
      background: rgba(0, 0, 0, 0.5); 
      border: 1px solid #444; 
      color: #fff; 
      border-radius: 8px;
      box-sizing: border-box;
      outline: none;
    }

    select:focus { border-color: var(--nebula-purple); }

    button { 
      background: var(--nebula-purple); 
      border: none; 
      font-weight: bold; 
      cursor: pointer; 
      transition: transform 0.2s, background 0.3s;
      margin-top: 15px;
    }

    button:hover { 
      background: #825ef5;
      transform: translateY(-2px); 
    }

    .download-btn { background: var(--success-green); }
    .download-btn:hover { background: #218838; }

    .table-container { 
      max-height: 250px; 
      overflow: auto; 
      background: rgba(0,0,0,0.3); 
      margin-top: 15px; 
      font-size: 0.85rem; 
      border-radius: 8px;
    }

    table { width: 100%; border-collapse: collapse; }
    th, td { border: 1px solid #333; padding: 10px; text-align: left; }
    th { background: #111; position: sticky; top: 0; color: var(--nebula-purple); }

    #chart-wrapper { 
      background: white; 
      padding: 25px; 
      border-radius: 16px; 
      margin-top: 20px; 
      height: 500px;
      position: relative;
    }
  </style>
</head>
<body>

<div class="container">
  <h2>ðŸ”­ Data Plotter</h2>

  <div class="card">
    <label>Upload Celestial Data (CSV, XLSX, XLS, JSON)</label>
    <input type="file" id="fileInput" accept=".csv, .xlsx, .xls, .json, .tsv">
    <div id="tableContainer" class="table-container"></div>
  </div>

  <div class="card grid">
    <div>
      <label>X-Axis (Independent Variable)</label>
      <select id="xSelect"></select>
      
      <label style="margin-top:15px;">X-Axis Scale</label>
      <select id="xScaleType">
        <option value="linear">Linear</option>
        <option value="logarithmic">Logarithmic</option>
      </select>
    </div>

    <div>
      <label>Y-Axis (Dependent Variable)</label>
      <select id="ySelect"></select>
      
      <label style="margin-top:15px;">Y-Axis Scale</label>
      <select id="yScaleType">
        <option value="linear">Linear</option>
        <option value="logarithmic">Logarithmic</option>
      </select>
    </div>

    <div style="grid-column: 1 / -1;">
      <label>Visualization Type</label>
      <select id="plotType">
        <option value="scatter">Scatter Plot (Precise Observations)</option>
        <option value="line">Line Chart (Trend Tracking)</option>
        <option value="bar">Bar Chart (Comparative Analysis)</option>
      </select>
      
      <div style="display: flex; gap: 10px;">
        <button onclick="plotData()">ðŸš€ Execute Visualization</button>
        <button class="download-btn" onclick="downloadChart()">ðŸ’¾ Save PNG</button>
      </div>
    </div>
  </div>

  <div id="chart-wrapper">
    <canvas id="mainChart"></canvas>
  </div>
</div>

<script>
let rawData = [];
let chartInstance = null;

// Handle File Upload
document.getElementById("fileInput").addEventListener("change", e => {
  const file = e.target.files[0];
  if (!file) return;

  const reader = new FileReader();
  reader.onload = event => {
    try {
      const data = new Uint8Array(event.target.result);
      const workbook = XLSX.read(data, { type: "array" });
      const firstSheet = workbook.Sheets[workbook.SheetNames[0]];
      
      // Convert to JSON
      rawData = XLSX.utils.sheet_to_json(firstSheet, { defval: null });
      
      if (rawData.length === 0) {
        alert("Discovery Failed: File appears to be empty.");
        return;
      }

      populateSelectors();
      showTable();
    } catch (err) {
      console.error(err);
      alert("Error parsing cosmic data. Please check the file format.");
    }
  };
  reader.readAsArrayBuffer(file);
});

function showTable() {
  const headers = Object.keys(rawData[0]);
  let html = "<table><thead><tr>" + headers.map(h => `<th>${h}</th>`).join('') + "</tr></thead><tbody>";
  
  // Preview first 5 rows
  rawData.slice(0, 5).forEach(row => {
    html += "<tr>" + headers.map(h => `<td>${row[h] ?? '-'}</td>`).join('') + "</tr>";
  });
  
  document.getElementById("tableContainer").innerHTML = html + "</tbody></table>";
}

function populateSelectors() {
  const headers = Object.keys(rawData[0]);
  const x = document.getElementById("xSelect");
  const y = document.getElementById("ySelect");
  x.innerHTML = y.innerHTML = "";
  
  headers.forEach(h => {
    x.add(new Option(h, h));
    y.add(new Option(h, h));
  });
}

function plotData() {
  const xCol = document.getElementById("xSelect").value;
  const yCol = document.getElementById("ySelect").value;
  const pType = document.getElementById("plotType").value;
  const xScale = document.getElementById("xScaleType").value;
  const yScale = document.getElementById("yScaleType").value;

  if (!rawData.length) return alert("Please upload a data source first.");
  if (chartInstance) chartInstance.destroy();

  // Data Cleaning & Log Scale Safety
  const processedData = rawData.map(r => ({
    x: parseFloat(r[xCol]),
    y: parseFloat(r[yCol]),
    label: String(r[xCol])
  })).filter(p => {
    if (pType === 'bar') return !isNaN(p.y); // Bar charts only strictly need numeric Y
    
    const isNumeric = !isNaN(p.x) && !isNaN(p.y);
    const xLogSafe = (xScale === 'logarithmic') ? p.x > 0 : true;
    const yLogSafe = (yScale === 'logarithmic') ? p.y > 0 : true;
    
    return isNumeric && xLogSafe && yLogSafe;
  });

  const ctx = document.getElementById("mainChart").getContext('2d');
  
  chartInstance = new Chart(ctx, {
    type: pType === 'bar' ? 'bar' : (pType === 'line' ? 'line' : 'scatter'),
    data: {
      labels: pType === 'bar' ? processedData.map(p => p.label) : [],
      datasets: [{
        label: `${yCol} vs ${xCol}`,
        data: pType === 'bar' ? processedData.map(p => p.y) : processedData.map(p => ({x: p.x, y: p.y})),
        backgroundColor: 'rgba(110, 69, 226, 0.5)',
        borderColor: '#6e45e2',
        borderWidth: 2,
        pointRadius: pType === 'scatter' ? 6 : 3,
        tension: 0.3 // Smoothes lines
      }]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      scales: {
        x: { 
          type: (pType === 'bar') ? 'category' : xScale,
          title: { display: true, text: xCol, font: { weight: 'bold' } }
        },
        y: { 
          type: yScale,
          title: { display: true, text: yCol, font: { weight: 'bold' } }
        }
      },
      plugins: {
        legend: { position: 'top' },
        tooltip: { mode: 'index', intersect: false }
      }
    }
  });
}

function downloadChart() {
  const canvas = document.getElementById('mainChart');
  const link = document.createElement('a');
  link.download = 'cosmic_observation.png';
  link.href = canvas.toDataURL('image/png');
  link.click();
}
</script>

</body>
</html>